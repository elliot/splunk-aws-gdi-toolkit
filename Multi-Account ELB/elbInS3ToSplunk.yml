---
AWSTemplateFormatVersion: 2010-09-09
Description: This is a CloudFormation template to create logging infrastructure for ELB logs in an S3 bucket to send to Splunk over HEC via Firehose - https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html

Parameters:
  service:
    Type: String
    Description: service name
    Default: splunk-aws-gdi-tooklit

  stage:
    Type: String
    Description: Used to distinguish between stages of an environment
    Default: dev

  contact:
    Description: Used to identify a contact for the resources created in this stack.  As an example, this could be an email address or username.
    Type: String

  elbLogS3FileExpirationInDays:
    Description: How many days to keep the VPC Flow Log files in S3.
    Default: 366
    Type: String

Resources:

  # S3 resources
  elbLogS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketEncryption: 
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Sub "${AWS::AccountId}-elblog-bucket"
      LifecycleConfiguration:
        Rules:
            - Id: !Sub "${AWS::AccountId}-elblog-bucket-cleanup"
              AbortIncompleteMultipartUpload:
                DaysAfterInitiation: 1
              Status: Enabled
            - Id: !Sub "$${AWS::AccountId}-elblog-bucket-expiration"
              ExpirationInDays: !Ref elbLogS3FileExpirationInDays
              Status: Enabled
      # NotificationConfiguration:
      #   QueueConfigurations:
      #     - Event: "s3:ObjectCreated:Put"
      #       Filter:
      #         S3Key:
      #           Rules:
      #             - Name: "suffix"
      #               Value: ".gz"
      #       Queue: !GetAtt vpcFlowLogS3BucketNotificationSQSQueue.Arn
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
      - Key: service
        Value: !Ref service
      - Key: stage
        Value: !Ref stage
      - Key: contact
        Value: !Ref contact

Outputs:
  elbLogS3BucketArn:
    Value: !GetAtt elbLogS3Bucket.Arn